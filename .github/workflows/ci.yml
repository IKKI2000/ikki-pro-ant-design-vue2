# 工作流名称
name: Continuous Integration

# 工作流触发事件
on:
  # 推送【主分支】时触发
  push:
    branches:
      - main

  # 允许从【Actions】选项卡手动运行此工作流
  workflow_dispatch:

# 部署到【GitHub Pages】的【GITHUB_TOKEN】作用域
permissions:
  contents: read
  pages: write
  id-token: write

# 允许一个并发部署
concurrency:
  group: pages
  cancel-in-progress: true

# 默认使用【Bash】
defaults:
  run:
    shell: bash

# 工作流由一个或多个工作组成
jobs:
  # 构建 ID
  build:
    # 构建名称
    name: Build
    # 构建运行环境
    runs-on: ubuntu-latest

    # 构建工作由一个或多个步骤组成
    steps:
      # 仓库【主分支】签出到【GITHUB_WORKSPACE】
      - name: Checkout
        uses: actions/checkout@v3
        with:
          repository: IKKI2000/ikki-pro-ant-design-vue2
          ref: main

      # 设置 Node.js
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 16

      # 缓存 Npm 提升构建速率
      - name: Cache Dependencies
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # 安装
      - name: Install
        run: npm ci

      # 构建
      - name: Build
        run: npm run build

      # 上传
      - name: Upload Artifact
        uses: actions/upload-pages-artifact@v1
        with:
          path: ./dist

  # 部署 ID
  deploy:
    # 部署名称
    name: Deploy
    # 部署环境
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    # 部署运行环境
    runs-on: ubuntu-latest
    # 依赖前置工作
    needs: build

    # 部署工作由一个或多个步骤组成
    steps:
      # 部署到【GitHub Pages】
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v1
